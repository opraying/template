name: üçé iOS Build

on:
  workflow_dispatch:
    inputs:
      profile:
        type: choice
        default: preview
        options:
          - preview
          - production
        description: 'EAS build profile'
  pull_request:
    branches:
      - main
      - test
      - staging
      - 'feat-*'
  push:
    branches:
      - main
      - test
      - staging
      - 'feat-*'

permissions:
  contents: read

concurrency:
  group: native-ios-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect:
    name: Detect iOS impact
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      impacted: ${{ steps.detect.outputs.surface-native-ios }}
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üöß Setup workspace
        uses: ./.github/actions/setup

      - name: üîç Detect surface
        id: detect
        run: tsx scripts/ci/detect-surfaces.ts --surface native-ios --format github

  fingerprint:
    name: Fingerprint diff (ios)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      requires_release: ${{ steps.fp.outputs.requires_release }}
      head_hash: ${{ steps.fp.outputs.head_hash }}
      base_hash: ${{ steps.fp.outputs.base_hash }}
      fallback_reason: ${{ steps.fp.outputs.fallback_reason }}
      head_sources: ${{ steps.fp.outputs.head_sources }}
      base_sources: ${{ steps.fp.outputs.base_sources }}
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üöß Setup workspace
        uses: ./.github/actions/setup

      - name: üîê Native fingerprint
        id: fp
        shell: bash
        run: |
          set -euo pipefail
          tsx scripts/ci/native-fingerprint.ts --platform ios --output fingerprint-ios.json | tee fingerprint-ios.log
          require_release=$(jq -r '.requiresStoreRelease' fingerprint-ios.json)
          head_hash=$(jq -r '.headHash' fingerprint-ios.json)
          base_hash=$(jq -r '.baseHash // ""' fingerprint-ios.json)
          fallback_reason=$(jq -r '.fallbackReason // ""' fingerprint-ios.json)
          head_sources=$(jq -r 'if .headFingerprint then (.headFingerprint.sources | length) else 0 end' fingerprint-ios.json)
          base_sources=$(jq -r 'if .baseFingerprint then (.baseFingerprint.sources | length) else 0 end' fingerprint-ios.json)
          {
            echo "requires_release=${require_release}"
            echo "head_hash=${head_hash}"
            echo "base_hash=${base_hash}"
            echo "fallback_reason=${fallback_reason}"
            echo "head_sources=${head_sources}"
            echo "base_sources=${base_sources}"
          } >> "$GITHUB_OUTPUT"

      - name: üì§ Upload fingerprint artifact
        uses: actions/upload-artifact@v5
        with:
          name: ios-fingerprint
          path: fingerprint-ios.json
          retention-days: 7

  classify:
    name: Determine native build need
    runs-on: ubuntu-latest
    needs: [detect, fingerprint]
    outputs:
      build_native: ${{ steps.compute.outputs.build_native }}
    steps:
      - name: Decide build
        id: compute
        shell: bash
        run: |
          set -euo pipefail
          build_native=false
          if [[ "${{ needs.detect.outputs.impacted }}" == 'true' ]]; then
            build_native=true
          fi
          if [[ "${{ needs.fingerprint.outputs.requires_release }}" == 'true' ]]; then
            build_native=true
          fi
          if [[ "${{ github.event_name }}" == 'workflow_dispatch' ]]; then
            build_native=true
          fi
          echo "build_native=${build_native}" >> "$GITHUB_OUTPUT"
          printf 'build_native=%s\n' "$build_native"

  build:
    name: Build iOS artifact
    needs: [classify]
    if: needs.classify.outputs.build_native == 'true' && github.secret_source != 'None'
    runs-on: macos-latest
    timeout-minutes: 120
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    steps:
      - name: ‚¨áÔ∏è Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: üöß Setup workspace
        uses: ./.github/actions/setup

      - name: üìã Determine build profile
        id: profile
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            PROFILE="${{ github.event.inputs.profile }}"
          elif [[ "${{ github.ref_name }}" == "main" ]]; then
            PROFILE="production"
          else
            PROFILE="preview"
          fi
          echo "profile=$PROFILE" >> "$GITHUB_OUTPUT"
          echo "EAS_IOS_PROFILE=$PROFILE" >> "$GITHUB_ENV"

      - name: üì± Setup EAS CLI
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üèóÔ∏è Run iOS stage
        run: tsx scripts/run-ci-stage.ts --stage native-ios --platform macos

      - name: üì¶ Package artifact
        id: package
        shell: bash
        run: |
          mkdir -p artifacts
          PROFILE="${{ steps.profile.outputs.profile }}"
          ARTIFACT_PATH="dist/native/ios-${PROFILE}.ipa"
          if [[ ! -f "$ARTIFACT_PATH" ]]; then
            echo "Artifact $ARTIFACT_PATH not found." >&2
            exit 1
          fi
          tar -czf "artifacts/native-ios-${PROFILE}.tar.gz" "$ARTIFACT_PATH"
          echo "artifact-name=native-ios-${PROFILE}" >> "$GITHUB_OUTPUT"
          echo "artifact-path=artifacts/native-ios-${PROFILE}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: ‚¨ÜÔ∏è Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ steps.package.outputs.artifact-name }}
          path: ${{ steps.package.outputs.artifact-path }}
          if-no-files-found: error
          retention-days: 7

  skip:
    name: Nothing to build
    needs: classify
    if: needs.classify.outputs.build_native != 'true'
    runs-on: ubuntu-latest
    steps:
      - run: echo "No iOS-related Nx projects changed. Skipping builds."
